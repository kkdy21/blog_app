{% extends "/layout/main_layout.html" %}

{% block content %}
<section class="max-w-5xl mx-auto space-y-8">
    <article class="space-y-4" data-aos="fade-up">
        <h1 class="text-3xl font-extrabold text-gray-900 dark:text-gray-100">{{ blog.title }}</h1>
        <p class="text-sm text-gray-500 dark:text-gray-400">{{ blog.modified_dt }} · {{ blog.author.name }}</p>
        <div class="h-80 w-full bg-gray-100 dark:bg-gray-700 overflow-hidden rounded-xl">
            <img src="{{ blog.image_loc }}" alt="Blog Image" class="w-full h-full object-cover" />
        </div>
        <div class="prose dark:prose-invert max-w-none">{{ blog.content | safe }}</div>
        <div class="flex flex-wrap gap-2">
            {% for tag in blog.tags %}
            <a href="/blogs/tags/{{ tag.name }}"
                class="text-xs px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-primary-50 hover:text-primary-700 transition">#{{
                tag.name }}</a>
            {% endfor %}
        </div>
        <div class="flex gap-3 pt-2">
            <a href="/blogs"
                class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 font-semibold px-5 py-2.5 rounded-lg transition">홈으로</a>
            {% if is_valid_auth %}
            <a href="/blogs/modify/{{ blog.id }}"
                class="bg-primary-600 hover:bg-primary-700 text-white font-semibold px-5 py-2.5 rounded-lg transition">수정</a>
            <button onclick="confirmDelete()"
                class="bg-red-600 hover:bg-red-700 text-white font-semibold px-5 py-2.5 rounded-lg transition">삭제</button>
            {% endif %}
        </div>
    </article>

    <section data-aos="fade-up" class="space-y-4">
        <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">Comments ({{ comments|length }})</h3>

        {% if session_user %}
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
            <form id="new-comment-form" class="space-y-3">
                <textarea id="new-comment-content"
                    class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500"
                    rows="3" placeholder="댓글을 입력하세요" required></textarea>
                <div class="text-right">
                    <button type="submit"
                        class="bg-primary-600 hover:bg-primary-700 text-white font-semibold px-4 py-2 rounded-lg transition">등록</button>
                </div>
            </form>
        </div>
        {% else %}
        <div
            class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-xl p-4 text-blue-700 dark:text-blue-300">
            <a href="/users/sign_in?next=/blogs/show/{{ blog.id }}" class="underline">로그인</a> 후 댓글을 작성할 수 있습니다.
        </div>
        {% endif %}

        <div id="comment-list" class="space-y-4"></div>
    </section>
</section>

<script>
    const BLOG_ID = {{ blog.id }};
    const SESSION_USER = {{ session_user.model_dump_json() | safe if session_user else 'null' }};
    const INITIAL_COMMENTS = {{ comments | tojson }};

    /**
     * Creates HTML for a single comment.
     * @param {object} comment - The comment data object.
     * @param {number} depth - The nesting depth of the comment.
     * @param {string|null} parentAuthorName - The name of the parent comment's author.
     */
    function createCommentHTML(comment, depth, parentAuthorName) {
        const createdAt = new Date(comment.created_at).toLocaleString();
        const isAuthor = SESSION_USER && SESSION_USER.id === comment.author.id;
        const authorName = comment.author ? comment.author.name : "Unknown";

        let actionsHTML = '';
        if (SESSION_USER) {
            actionsHTML += `<a href="javascript:void(0);" class="me-2 small" onclick="showReplyForm(${comment.id})">Reply</a>`;
            if (isAuthor) {
                actionsHTML += `
                    <a href="javascript:void(0);" class="me-2 small" onclick="showEditForm(${comment.id})">Edit</a>
                    <a href="javascript:void(0);" class="small" onclick="deleteComment(${comment.id})">Delete</a>
                `;
            }
        }

        // All replies (depth > 0) get a single, non-cumulative indentation level.
        const indentClass = depth > 0 ? 'pl-6 border-l-2 border-gray-200 dark:border-gray-700' : '';
        const replyToHTML = parentAuthorName ? `<a href=\"#comment-${comment.parent_id}\" class=\"text-primary-600 font-semibold mr-1\">@${parentAuthorName}</a>` : '';

        return `
        <div class=\"flex gap-3 ${indentClass}\" id=\"comment-${comment.id}\" data-author-name=\"${authorName}\">\n            <img class=\"w-10 h-10 rounded-full\" src=\"https://dummyimage.com/50x50/ced4da/6c757d.jpg\" alt=\"avatar\"/>\n            <div class=\"flex-1\">\n                <div class=\"font-semibold text-gray-900 dark:text-gray-100\">${authorName} <span class=\"text-xs text-gray-500 dark:text-gray-400\">· ${createdAt}</span></div>\n                <div class=\"text-gray-800 dark:text-gray-200 comment-content\">${replyToHTML}${comment.content}</div>\n                <div class=\"mt-1 comment-actions\">${actionsHTML}</div>\n                <div id=\"reply-form-${comment.id}\" class=\"mt-3 hidden\">\n                    <form onsubmit=\"submitReply(event, ${comment.id})\" class=\"space-y-2\">\n                        <textarea class=\"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 px-3 py-2\" name=\"content\" rows=\"2\" required></textarea>\n                        <div class=\"flex gap-2\">\n                            <button class=\"bg-primary-600 hover:bg-primary-700 text-white text-sm px-3 py-1.5 rounded-lg\">Reply</button>\n                            <button type=\"button\" class=\"bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 text-sm px-3 py-1.5 rounded-lg\" onclick=\"hideReplyForm(${comment.id})\">Cancel</button>\n                        </div>\n                    </form>\n                </div>\n                <div id=\"edit-form-${comment.id}\" class=\"mt-3 hidden\">\n                    <form onsubmit=\"submitEdit(event, ${comment.id})\" class=\"space-y-2\">\n                        <textarea class=\"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 px-3 py-2\" name=\"content\" rows=\"2\" required>${comment.content}</textarea>\n                        <div class=\"flex gap-2\">\n                            <button class=\"bg-primary-600 hover:bg-primary-700 text-white text-sm px-3 py-1.5 rounded-lg\">Save</button>\n                            <button type=\"button\" class=\"bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 text-sm px-3 py-1.5 rounded-lg\" onclick=\"hideEditForm(${comment.id})\">Cancel</button>\n                        </div>\n                    </form>\n                </div>\n            </div>\n        </div>`;
    }

    function createElementFromHTML(htmlString) {
        const div = document.createElement('div');
        div.innerHTML = htmlString.trim();
        return div.firstChild;
    }

    function renderComments() {
        const container = document.getElementById('comment-list');
        container.innerHTML = '';

        const commentMap = {};
        function buildCommentMap(comments) {
            comments.forEach(comment => {
                commentMap[comment.id] = comment;
                if (comment.replies) {
                    buildCommentMap(comment.replies);
                }
            });
        }
        buildCommentMap(INITIAL_COMMENTS);

        INITIAL_COMMENTS.forEach(rootComment => {
            const rootElement = createElementFromHTML(createCommentHTML(rootComment, 0, null));
            container.appendChild(rootElement);

            const replies = [];
            function collectReplies(comment) {
                if (comment.replies) {
                    comment.replies.forEach(reply => {
                        replies.push(reply);
                        collectReplies(reply);
                    });
                }
            }
            collectReplies(rootComment);

            replies.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

            replies.forEach(reply => {
                const parent = commentMap[reply.parent_id];
                const parentAuthorName = parent ? parent.author.name : null;
                // Pass depth as 1 for all replies to maintain same indentation
                const replyElement = createElementFromHTML(createCommentHTML(reply, 1, parentAuthorName));
                container.appendChild(replyElement);
            });
        });
    }

    // UI 제어
    function showReplyForm(id) { document.getElementById(`reply-form-${id}`).classList.remove('hidden'); }
    function hideReplyForm(id) { document.getElementById(`reply-form-${id}`).classList.add('hidden'); }
    function showEditForm(id) { const d = document.getElementById(`comment-${id}`); d.querySelector('.comment-content').classList.add('hidden'); d.querySelector('.comment-actions').classList.add('hidden'); document.getElementById(`edit-form-${id}`).classList.remove('hidden'); }
    function hideEditForm(id) { const d = document.getElementById(`comment-${id}`); d.querySelector('.comment-content').classList.remove('hidden'); d.querySelector('.comment-actions').classList.remove('hidden'); document.getElementById(`edit-form-${id}`).classList.add('hidden'); }

    // Form 핸들러
    async function handleApiResponse(res) {
        if (!res.ok) { const err = await res.json(); alert(`Error: ${err.detail}`); return null; }
        return res.json();
    }

    // --- Form Handlers (revert to location.reload()) ---
    async function submitNewComment(e) {
        e.preventDefault();
        const content = document.getElementById('new-comment-content').value;
        const data = { content, blog_id: BLOG_ID, parent_id: null };
        const response = await fetch('/comments/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        if (response.ok) location.reload();
        else { const err = await response.json(); alert(`Error: ${err.detail}`); }
    }

    async function submitReply(e, parentId) {
        e.preventDefault();
        const content = e.target.querySelector('textarea').value;
        const data = { content, blog_id: BLOG_ID, parent_id: parentId };
        const response = await fetch('/comments/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        if (response.ok) location.reload();
        else { const err = await response.json(); alert(`Error: ${err.detail}`); }
    }

    async function submitEdit(e, commentId) {
        e.preventDefault();
        const content = e.target.querySelector('textarea').value;
        const data = { content, blog_id: BLOG_ID };
        const response = await fetch(`/comments/${commentId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        if (response.ok) location.reload();
        else { const err = await response.json(); alert(`Error: ${err.detail}`); }
    }

    async function deleteComment(id) {
        if (!confirm('삭제하시겠습니까?')) return;
        const response = await fetch(`/comments/${id}`, { method: 'DELETE' });
        if (response.ok) location.reload();
        else { const err = await response.json(); alert(`Error: ${err.detail}`); }
    }

    // 초기 렌더링
    document.addEventListener('DOMContentLoaded', renderComments);
    document.getElementById('new-comment-form')?.addEventListener('submit', submitNewComment);

    // 블로그 삭제
    async function confirmDelete() {
        if (!confirm('블로그를 정말 삭제하시겠습니까?')) return;
        try {
            const res = await fetch("/blogs/delete/{{ blog.id }}", { method: 'DELETE', headers: { 'Content-Type': 'application/json' } });
            if (res.ok) { await res.json(); window.location.href = "/blogs"; }
            else { const err = await res.json(); alert(`Error: ${err.detail}`); }
        } catch (err) { console.error(err); alert('권한이 없습니다.'); }
    }
</script>
{% endblock %}